<!DOCTYPE html>
<html lang="vn">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Đơn hàng - Spark Flower</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <div
      class="seller-header d-flex align-items-center justify-content-between px-4 py-3 shadow-sm"
    >
      <div class="d-flex align-items-center">
        <img src="asset/hinhanh/logo2 (2).png" width="120" class="me-3" />
      </div>

      <h3 class="fw-bold m-0" style="color: #a1152c">SPARK SELLER</h3>

      <div style="width: 120px"></div>
    </div>

    <div class="sidebar">
      <ul class="nav flex-column mt-4">
        <li class="nav-item">
          <a
            href="seller.html"
            class="nav-link active fs-4 fw-bold"
            style="color: #d3213f"
          >
            <i class="fas fa-chart-line me-2 fs-3"></i> Tổng quan
          </a>
        </li>
        <li class="nav-item">
          <a
            href="seller_product.html"
            class="nav-link fs-4 fw-bold"
            style="color: #d3213f"
          >
            <i class="fas fa-box-open me-2"></i> Sản phẩm
          </a>
        </li>
        <li class="nav-item">
          <a
            href="seller_orders.html"
            class="nav-link fs-4 fw-bold"
            style="color: #d3213f"
          >
            <i class="fas fa-shopping-cart me-2"></i> Đơn hàng
          </a>
        </li>
        <li class="nav-item">
          <a
            href="index.html"
            class="nav-link fs-4 fw-bold"
            style="color: #d3213f"
          >
            <i class="fas fa-sign-out-alt me-2"></i> Về trang chủ
          </a>
        </li>
      </ul>
    </div>

    <div class="main-content">
      <h2
        class="mb-4 fw-bold text-center text-uppercase"
        style="color: #31020a"
      >
        Quản lý đơn hàng
      </h2>
      <div class="card shadow border-0">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover table-bordered align-middle">
              <thead class="table-dark">
                <tr>
                  <th>Mã Đơn</th>
                  <th>Ngày đặt</th>
                  <th>Khách hàng</th>
                  <th>Sản phẩm</th>
                  <th>Tổng tiền</th>
                  <th>Hành động</th>
                </tr>
              </thead>
              <tbody id="order-list"></tbody>
            </table>
          </div>
          <div id="empty-msg" class="text-center py-4 d-none">
            Chưa có đơn hàng nào!
          </div>
        </div>
      </div>

      <div class="text-center mt-3">
        <button class="btn btn-warning" onclick="clearAllOrders()">
          Xóa tất cả dữ liệu
        </button>
      </div>
    </div>

    <div class="modal fade" id="detailModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Chi tiết đơn hàng</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="modal-body-detail"></div>
        </div>
      </div>
    </div>

    <script>
      // --- PHẦN DEBUG (KIỂM TRA LỖI) ---
      function checkDebug() {
        const data = localStorage.getItem("orders");
        if (!data) {
          console.log(
            "DEBUG: Không tìm thấy dữ liệu 'orders' trong LocalStorage."
          );
          // alert("Chưa có đơn hàng nào được lưu trong bộ nhớ trình duyệt!");
        } else {
          const parsed = JSON.parse(data);
          console.log("DEBUG: Tìm thấy " + parsed.length + " đơn hàng.");
        }
      }

      // --- PHẦN HIỂN THỊ CHÍNH ---
      function renderOrderTable() {
        const tbody = document.getElementById("order-list");
        const emptyMsg = document.getElementById("empty-msg");

        // 1. Lấy dữ liệu
        const orders = JSON.parse(localStorage.getItem("orders") || "[]");

        // 2. Kiểm tra dữ liệu rỗng
        if (orders.length === 0) {
          if (tbody) tbody.innerHTML = "";
          if (emptyMsg) emptyMsg.classList.remove("d-none");
          return;
        }

        // 3. Ẩn thông báo rỗng
        if (emptyMsg) emptyMsg.classList.add("d-none");

        // 4. Vẽ bảng
        if (tbody) {
          tbody.innerHTML = orders
            .map((order, index) => {
              const productSummary = order.items
                ? order.items.map((i) => `${i.name} (x${i.qty})`).join(", ")
                : "Lỗi SP";
              const totalMoney = order.total
                ? parseInt(order.total).toLocaleString()
                : 0;

              return `
                        <tr>
                            <td class="fw-bold text-danger">${order.id}</td>
                            <td>${order.date}</td>
                            <td>
                                <span class="fw-bold">${order.customer.name}</span><br>
                                <small>${order.customer.phone}</small>
                            </td>
                            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${productSummary}">
                                ${productSummary}
                            </td>
                            <td class="fw-bold text-success">${totalMoney} đ</td>
                            <td>
                                <button class="btn btn-sm btn-info text-white me-1" onclick="viewDetail(${index})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteOrder(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
            })
            .join("");
        }
      }

      function viewDetail(index) {
        const orders = JSON.parse(localStorage.getItem("orders") || "[]");
        const order = orders[index];
        if (!order) return;

        const itemsHtml = order.items
          .map(
            (item) => `
                <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
                    <div class="d-flex align-items-center">
                        <img src="${
                          item.img
                        }" width="50" class="me-2 rounded" style="object-fit:cover;">
                        <div>
                            <strong>${item.name}</strong><br>
                            <small class="text-muted">${parseInt(
                              item.price
                            ).toLocaleString()} x ${item.qty}</small>
                        </div>
                    </div>
                    <span class="fw-bold">${(
                      item.price * item.qty
                    ).toLocaleString()} đ</span>
                </div>
            `
          )
          .join("");

        const detailHtml = `
                <div class="mb-3">
                    <p><strong>Mã:</strong> ${
                      order.id
                    } <span class="badge bg-warning text-dark">${
          order.status
        }</span></p>
                    <p><strong>Khách:</strong> ${order.customer.name} - ${
          order.customer.phone
        }</p>
                    <p><strong>Địa chỉ:</strong> ${order.customer.address}</p>
                    <p><strong>Thanh toán:</strong> ${
                      order.customer.payment || "COD"
                    }</p>
                </div>
                <h6>Sản phẩm:</h6>
                <div class="bg-light p-2 rounded mb-2">${itemsHtml}</div>
                <h5 class="text-end text-danger">Tổng: ${parseInt(
                  order.total
                ).toLocaleString()} VNĐ</h5>
            `;

        const detailBody = document.getElementById("modal-body-detail");
        if (detailBody) detailBody.innerHTML = detailHtml;

        const modalEl = document.getElementById("detailModal");
        if (modalEl) new bootstrap.Modal(modalEl).show();
      }

      function deleteOrder(index) {
        if (confirm("Bạn có chắc chắn muốn xóa đơn hàng này?")) {
          let orders = JSON.parse(localStorage.getItem("orders") || "[]");
          orders.splice(index, 1);
          localStorage.setItem("orders", JSON.stringify(orders));
          renderOrderTable();
        }
      }

      function clearAllOrders() {
        if (confirm("Xóa tất cả đơn hàng?")) {
          localStorage.removeItem("orders");
          renderOrderTable();
        }
      }

      // --- KHỞI CHẠY ---
      document.addEventListener("DOMContentLoaded", () => {
        checkDebug(); // Kiểm tra xem có dữ liệu không
        renderOrderTable(); // Vẽ bảng
      });

      window.addEventListener("storage", function (e) {
        if (e.key === "orders") renderOrderTable();
      });
      function renderOrderTable() {
        const tbody = document.getElementById("order-list");
        const emptyMsg = document.getElementById("empty-msg");

        // 1. Lấy dữ liệu
        const orders = JSON.parse(localStorage.getItem("orders") || "[]");

        // 2. Kiểm tra dữ liệu rỗng
        if (!orders || orders.length === 0) {
          if (tbody) tbody.innerHTML = "";
          if (emptyMsg) emptyMsg.classList.remove("d-none");
          return;
        }

        // 3. Ẩn thông báo rỗng
        if (emptyMsg) emptyMsg.classList.add("d-none");

        // 4. Vẽ bảng (CODE AN TOÀN ĐÃ CẬP NHẬT)
        if (tbody) {
          tbody.innerHTML = orders
            .map((order, index) => {
              // Kiểm tra an toàn: Nếu order hoặc customer không tồn tại thì tạo dữ liệu giả
              const cusName = order.customer?.name || "Khách (Lỗi data)";
              const cusPhone = order.customer?.phone || "---";

              // Kiểm tra an toàn: items
              let productSummary = "Không có sản phẩm";
              if (Array.isArray(order.items)) {
                productSummary = order.items
                  .map((i) => {
                    // Chống lỗi nếu item bị null
                    return `${i?.name || "SP Lỗi"} (x${i?.qty || 0})`;
                  })
                  .join(", ");
              }

              const totalMoney = order.total
                ? parseInt(order.total).toLocaleString()
                : "0";

              return `
                        <tr>
                            <td class="fw-bold text-danger">${
                              order.id || "N/A"
                            }</td>
                            <td>${order.date || "---"}</td>
                            <td>
                                <span class="fw-bold">${cusName}</span><br>
                                <small>${cusPhone}</small>
                            </td>
                            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${productSummary}">
                                ${productSummary}
                            </td>
                            <td class="fw-bold text-success">${totalMoney} đ</td>
                            <td>
                                <button class="btn btn-sm btn-info text-white me-1" onclick="viewDetail(${index})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteOrder(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
            })
            .join("");
        }
      }
    </script>
  </body>
</html>
