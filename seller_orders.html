<!DOCTYPE html>
<html lang="vn">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Đơn hàng - Spark Flower</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link href="asset/css/selller_orders.css" rel="stylesheet" />
  </head>
  <body>
    <div
      class="seller-header d-flex align-items-center justify-content-between px-4 py-3 shadow-sm"
    >
      <div class="d-flex align-items-center">
        <img src="asset/hinhanh/logo2 (2).png" width="120" class="me-3" />
      </div>

      <h3 class="fw-bold m-0" style="color: #a1152c">SPARK SELLER</h3>

      <div style="width: 120px"></div>
    </div>

    <div class="sidebar">
      <ul class="nav flex-column mt-4">
        <li class="nav-item">
          <a
            href="seller.html"
            class="nav-link active fs-4 fw-bold"
            style="color: #d3213f"
          >
            <i class="fas fa-chart-line me-2 fs-3"></i> Tổng quan
          </a>
        </li>
        <li class="nav-item">
          <a
            href="seller_category.html"
            class="nav-link fs-4 fw-bold"
            style="color: #d3213f"
          >
            <i class="fas fa-tags me-2"></i> Danh mục
          </a>
        </li>
        <li class="nav-item">
          <a
            href="seller_product.html"
            class="nav-link fs-4 fw-bold"
            style="color: #d3213f"
          >
            <i class="fas fa-box-open me-2"></i> Sản phẩm
          </a>
        </li>
        <li class="nav-item">
          <a
            href="seller_orders.html"
            class="nav-link fs-4 fw-bold"
            style="color: #d3213f"
          >
            <i class="fas fa-shopping-cart me-2"></i> Đơn hàng
          </a>
        </li>
        <li class="nav-item">
          <a
            href="index.html"
            class="nav-link fs-4 fw-bold"
            style="color: #d3213f"
          >
            <i class="fas fa-sign-out-alt me-2"></i> Về trang chủ
          </a>
        </li>
      </ul>
    </div>

    <div class="main-content">
      <h2
        class="mb-4 fw-bold text-center text-uppercase"
        style="color: #31020a"
      >
        Quản lý đơn hàng
      </h2>
      <div class="card border-0 shadow-sm p-4" style="border-radius: 15px">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="fw-bold">
            <i class="fas fa-list-alt me-2"></i>Danh sách đơn hàng
          </h5>
          <button
            class="btn btn-sm btn-outline-danger"
            onclick="clearAllOrders()"
          >
            <i class="fas fa-trash-alt me-1"></i> Xóa tất cả
          </button>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>Mã Đơn</th>
                <th>Ngày đặt</th>
                <th>Khách hàng</th>
                <th style="width: 250px">Sản phẩm mua</th>
                <th>Trạng thái</th>
                <th>Tổng tiền</th>
                <th class="text-end">Hành động</th>
              </tr>
            </thead>
            <tbody id="order-list"></tbody>
          </table>
          <div id="empty-msg" class="text-center py-5 d-none text-muted">
            <i class="fas fa-box-open fs-1 mb-3 opacity-50"></i>
            <p>Chưa có đơn hàng nào!</p>
          </div>
        </div>
      </div>

      <div class="text-center mt-3">
        <button class="btn btn-warning" onclick="clearAllOrders()">
          Xóa tất cả dữ liệu
        </button>
      </div>
    </div>

    <div class="modal fade" id="detailModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fw-bold">Chi tiết đơn hàng</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="modal-body-detail"></div>
        </div>
      </div>
    </div>

    <script>
      const STATUS_MAP = {
        "Chờ xử lý": "status-cho-xu-ly",
        "Đang giao": "status-dang-giao",
        "Hoàn tất": "status-hoan-tat",
        "Đã hủy": "status-da-huy",
      };

      function renderOrderTable() {
        const tbody = document.getElementById("order-list");
        const emptyMsg = document.getElementById("empty-msg");
        const orders = JSON.parse(localStorage.getItem("orders") || "[]");

        if (orders.length === 0) {
          tbody.innerHTML = "";
          emptyMsg.classList.remove("d-none");
          return;
        }
        emptyMsg.classList.add("d-none");

        tbody.innerHTML = orders
          .map((order, index) => {
            const statusClass =
              STATUS_MAP[order.status] || "bg-light text-dark";
            const totalMoney = order.total
              ? parseInt(order.total).toLocaleString()
              : "0";

            // --- TẠO HTML DANH SÁCH SẢN PHẨM NHỎ GỌN ---
            let productListHtml = "";
            if (order.items && order.items.length > 0) {
              // Chỉ hiện tối đa 2 sản phẩm, nếu nhiều hơn thì hiện "+3 sản phẩm khác"
              const displayItems = order.items.slice(0, 2);

              productListHtml = displayItems
                .map((i) => {
                  // Xử lý ảnh (nếu là base64 hoặc đường dẫn)
                  let img = i.img;
                  if (!img.startsWith("data:") && !img.startsWith("asset")) {
                    // Nếu chỉ lưu tên file, ta thử tìm trong kho ảnh upload
                    const stored = localStorage.getItem("img_" + i.img);
                    if (stored) img = stored;
                  }

                  return `
                            <div class="product-list-item">
                                <img src="${img}" onerror="this.src='https://placehold.co/30?text=Img'">
                                <div>
                                    <div class="fw-bold text-dark" style="font-size: 0.85rem; line-height:1.2;">${i.name}</div>
                                    <div class="text-muted" style="font-size: 0.75rem;">x${i.qty}</div>
                                </div>
                            </div>
                        `;
                })
                .join("");

              if (order.items.length > 2) {
                productListHtml += `<small class="text-primary fst-italic">+${
                  order.items.length - 2
                } sản phẩm khác...</small>`;
              }
            } else {
              productListHtml =
                '<span class="text-muted small">Không có sản phẩm</span>';
            }

            // --- NÚT HÀNH ĐỘNG ---
            let actionButtons = "";
            if (order.status === "Chờ xử lý") {
              actionButtons = `
                        <button class="btn btn-sm btn-success me-1" onclick="updateStatus(${index}, 'Đang giao')" title="Duyệt đơn"><i class="fas fa-check"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="updateStatus(${index}, 'Đã hủy')" title="Hủy đơn"><i class="fas fa-times"></i></button>
                    `;
            } else if (order.status === "Đang giao") {
              actionButtons = `
                        <button class="btn btn-sm btn-primary" onclick="updateStatus(${index}, 'Hoàn tất')" title="Xác nhận đã giao"><i class="fas fa-check-double"></i> Xong</button>
                    `;
            } else {
              actionButtons = `
                        <button class="btn btn-sm btn-outline-secondary" onclick="deleteOrder(${index})" title="Xóa"><i class="fas fa-trash"></i></button>
                    `;
            }

            return `
                    <tr>
                        <td><span class="fw-bold text-primary">${order.id.slice(
                          -6
                        )}</span></td>
                        <td><small class="text-muted">${order.date}</small></td>
                        <td>
                            <div class="fw-bold" style="font-size: 0.9rem;">${
                              order.customer.name
                            }</div>
                            <small class="text-muted" style="font-size: 0.8rem;">${
                              order.customer.phone
                            }</small>
                        </td>
                        
                        <td>${productListHtml}</td>
                        
                        <td><span class="badge-status ${statusClass}">${
              order.status
            }</span></td>
                        <td class="fw-bold text-danger">${totalMoney} đ</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-info text-white me-1" onclick="viewDetail(${index})" title="Xem chi tiết"><i class="fas fa-eye"></i></button>
                            ${actionButtons}
                        </td>
                    </tr>
                `;
          })
          .join("");
      }

      function updateStatus(index, newStatus) {
        let orders = JSON.parse(localStorage.getItem("orders") || "[]");
        orders[index].status = newStatus;
        localStorage.setItem("orders", JSON.stringify(orders));
        renderOrderTable();
      }

      function viewDetail(index) {
        const orders = JSON.parse(localStorage.getItem("orders") || "[]");
        const order = orders[index];
        if (!order) return;

        const itemsHtml = order.items
          .map(
            (i) => `
                <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
                    <div class="d-flex align-items-center">
                        <img src="${
                          i.img
                        }" width="40" class="rounded me-2" onerror="this.src='https://placehold.co/40'">
                        <div>
                            <div class="fw-bold">${i.name}</div>
                            <small class="text-muted">Giá: ${parseInt(
                              i.price
                            ).toLocaleString()}đ x ${i.qty}</small>
                        </div>
                    </div>
                    <span class="fw-bold text-danger">${(
                      i.price * i.qty
                    ).toLocaleString()}đ</span>
                </div>
            `
          )
          .join("");

        document.getElementById("modal-body-detail").innerHTML = `
                <div class="alert alert-info d-flex justify-content-between align-items-center">
                    <strong>Trạng thái: ${order.status}</strong>
                    <small>${order.date}</small>
                </div>
                <p><strong>Khách hàng:</strong> ${order.customer.name} (${
          order.customer.phone
        })</p>
                <p><strong>Địa chỉ:</strong> ${order.customer.address}</p>
                <p><strong>Thanh toán:</strong> ${order.customer.payment}</p>
                <div class="bg-light p-3 rounded mt-3">
                    <h6 class="border-bottom pb-2 mb-3">Danh sách sản phẩm</h6>
                    ${itemsHtml}
                    <div class="d-flex justify-content-between mt-3 pt-2 border-top">
                        <span class="fw-bold">Tổng cộng:</span>
                        <span class="fw-bold text-danger fs-5">${parseInt(
                          order.total
                        ).toLocaleString()} VNĐ</span>
                    </div>
                </div>
            `;
        new bootstrap.Modal(document.getElementById("detailModal")).show();
      }

      function deleteOrder(index) {
        if (confirm("Bạn có chắc muốn xóa vĩnh viễn đơn hàng này?")) {
          let orders = JSON.parse(localStorage.getItem("orders") || "[]");
          orders.splice(index, 1);
          localStorage.setItem("orders", JSON.stringify(orders));
          renderOrderTable();
        }
      }

      function clearAllOrders() {
        if (confirm("CẢNH BÁO: Xóa tất cả dữ liệu đơn hàng?")) {
          localStorage.removeItem("orders");
          renderOrderTable();
        }
      }

      document.addEventListener("DOMContentLoaded", renderOrderTable);
      window.addEventListener("storage", (e) => {
        if (e.key === "orders") renderOrderTable();
      });
    </script>
  </body>
</html>
